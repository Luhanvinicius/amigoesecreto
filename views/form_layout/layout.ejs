<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="author" content="form-one">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="csrf-token" content="<%= csrfToken || 'csrf-token' %>">
    <title><%= business.name %></title>
    <meta name="description" content="form-one">
    <meta name="keywords" content="form-one">
    <link rel="icon" href="<%= asset('form_layouts/' + business.layouts + '/images/favicon.png') %>">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="<%= asset('form_layouts/' + business.layouts + '/css/main-style.css') %>">
    <link rel="stylesheet" href="<%= asset('form_layouts/' + business.layouts + '/css/responsive.css') %>">
    <link rel="stylesheet" href="<%= asset('module_assets/loader.css') %>">
    <link rel="stylesheet" href="<%= asset('assets/css/bootstrap-datepicker.min.css') %>">

    <!-- PWA -->
    <meta name="mobile-wep-app-capable" content="yes">
    <meta name="apple-mobile-wep-app-capable" content="yes">
    <meta name="msapplication-starturl" content="/">
    <% if (business.enable_pwa === 'on') { %>
        <link rel="manifest" href="<%= asset('uploads/theme_app/business_' + business.id + '/manifest.json') %>" />
    <% } %>

    <style>
        #paiementpro-info .radio-group label::before,
        #paiementpro-info .radio-group label::after {
            display: none;
        }
        
        /* Garantir que tabs inativos estejam escondidos e seus campos n√£o sejam validados */
        .tabs-container .tab-content {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
        }
        
        .tabs-container .tab-content.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            overflow: visible !important;
        }
        
        /* Desabilitar valida√ß√£o HTML5 em campos escondidos */
        .tabs-container .tab-content:not(.active) input[required],
        .tabs-container .tab-content:not(.active) select[required],
        .tabs-container .tab-content:not(.active) textarea[required] {
            display: none !important;
        }
    </style>
</head>

<body class="form-one Formlayout1-<%= business.theme_color %>">
    <%- include('../web_layouts/appointment-tracking') %>

    <% if (typeof content !== 'undefined') { %>
        <%- content %>
    <% } else if (typeof body !== 'undefined') { %>
        <%- body %>
    <% } else { %>
        <%- include('../form_layout/Formlayout1/form-content') %>
    <% } %>

    <div class="top-0 p-3 position-fixed end-0" style="z-index: 99999">
        <div id="liveToast" class="text-white toast fade" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body"></div>
                <button type="button" class="m-auto btn-close btn-close-white me-2" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div id="loader" class="loader-wrappers" style="display: none;">
        <span class="site-loaders"></span>
        <h4 class="loader-content"><%= __('Loading . . .') %></h4>
    </div>

    <script src="<%= asset('form_layouts/' + business.layouts + '/js/jquery.min.js') %>"></script>
    <script src="<%= asset('form_layouts/' + business.layouts + '/js/custom.js') %>"></script>
    <script src="<%= asset('assets/js/custom-bootstrap.js') %>"></script>
    <script src="<%= asset('assets/js/bootstrap-datepicker.js') %>"></script>
    <script src="<%= asset('assets/js/plugins/bootstrap.min.js') %>"></script>
    <script src="<%= asset('module_assets/loader.js') %>"></script>
    <script src="<%= asset('js/custom.js') %>"></script>

    <script>
        $(document).ready(function() {
            // Fun√ß√£o para remover required de campos escondidos
            function removeRequiredFromHiddenFields() {
                $('#appointment-form .tab-content').each(function() {
                    var $tab = $(this);
                    var isActive = $tab.hasClass('active') && $tab.css('display') !== 'none';
                    
                    if (!isActive) {
                        // Remover required de todos os campos deste tab n√£o ativo
                        $tab.find('input[required], select[required], textarea[required]').each(function() {
                            var $field = $(this);
                            if (!$field.attr('data-was-required')) {
                                $field.attr('data-was-required', 'true');
                            }
                            $field.prop('required', false);
                            // N√ÉO desabilitar aqui - apenas remover required
                        });
                    } else {
                        // Restaurar required nos campos do tab ativo e garantir que est√£o habilitados
                        $tab.find('[data-was-required="true"]').each(function() {
                            var $field = $(this);
                            $field.prop('required', true);
                            $field.removeAttr('data-was-required');
                        });
                        // CR√çTICO: Garantir que TODOS os campos do tab ativo est√£o habilitados e edit√°veis
                        $tab.find('input, select, textarea').prop('disabled', false).prop('readonly', false);
                    }
                });
            }
            
            // Executar ao carregar
            removeRequiredFromHiddenFields();
            
            // Inicializar niceSelect
            if (typeof $.fn.niceSelect === 'function') {
                $('select').niceSelect();
            }
            
            // Pr√©-selecionar servi√ßo se vier na URL
            <% if (typeof selectedService !== 'undefined' && selectedService) { %>
            setTimeout(function() {
                var selectedServiceId = '<%= selectedService %>';
                $('#serviceSelect').val(selectedServiceId);
                if (typeof $('#serviceSelect').niceSelect === 'function') {
                    $('#serviceSelect').niceSelect('update');
                }
                $('#serviceSelect').trigger('change');
            }, 300);
            <% } %>
            
            //service & location wise staff dropdown start
            $('#serviceSelect, #locationSelect').change(function() {
                var serviceValue = $('#serviceSelect').val();
                var locationValue = $('#locationSelect').val();

                if (serviceValue && locationValue) {
                    fetchStaffData(serviceValue, locationValue);
                } else {
                    $('#staffSelect').empty();
                }
            });

            function fetchStaffData(serviceId, locationId) {
                $('#loader').fadeIn();
                $.ajax({
                    url: '/api/appointments/staff/data',
                    method: 'GET',
                    data: {
                        service: serviceId,
                        location: locationId
                    },
                    success: function(response) {
                        $('#loader').fadeOut();
                        updateStaffDropdown(response);
                    },
                    error: function() {
                        $('#loader').fadeOut();
                    }
                });
            }

            function updateStaffDropdown(staffData) {
                var staffSelect = $('#staffSelect');
                staffSelect.empty();
                staffSelect.append($('<option>', {
                    value: '',
                    text: '<%= __('Select staff') %>'
                }));
                $.each(staffData, function(index, staff) {
                    staffSelect.append($('<option>', {
                        value: staff.user.id,
                        text: staff.name
                    }));
                });
                // Atualizar niceSelect se estiver dispon√≠vel
                if (typeof staffSelect.niceSelect === 'function') {
                    staffSelect.niceSelect('update');
                }
            }
            
            // Inicializar niceSelect nos selects
            if (typeof $.fn.niceSelect === 'function') {
                $('select').niceSelect();
            }

            // Datepicker
            var daysOfWeek = [];
            var unavailableDates = [];

            $('#datepicker').datepicker({
                startDate: '+0d',
                format: 'dd-mm-yyyy',
                autoclose: true,
                daysOfWeekDisabled: daysOfWeek,
                datesDisabled: unavailableDates
            });

            // TimeSlot duration
            $('#serviceSelect').change(function() {
                var selectedService = $(this).val();
                var selectedDate = $('#datepicker').val();
                appointmentTimeSlot(selectedService, selectedDate);
            });

            $('#datepicker').on('changeDate', function() {
                var selectedService = $('#serviceSelect').val();
                var selectedDate = $(this).val();
                appointmentTimeSlot(selectedService, selectedDate);
            });

            function appointmentTimeSlot(serviceId, date) {
                if (!serviceId || !date) return;

                $('#loader').fadeIn();
                $.ajax({
                    url: '/api/appointments/duration',
                    method: 'POST',
                    data: {
                        service_id: serviceId,
                        date: date
                    },
                    success: function(response) {
                        $('#loader').fadeOut();
                        if (response.success && response.timeSlots) {
                            renderTimeSlots(response.timeSlots);
                        }
                    },
                    error: function() {
                        $('#loader').fadeOut();
                    }
                });
            }

            // Vari√°vel global para armazenar os timeSlots atuais
            var currentTimeSlots = [];
            
            function renderTimeSlots(timeSlots) {
                var container = $('#timeSlotsContainer');
                container.empty();
                
                // Armazenar os timeSlots para valida√ß√£o posterior
                currentTimeSlots = timeSlots || [];
                
                if (timeSlots.length === 0) {
                    container.append('<li style="color: #666; padding: 1rem;">Nenhum hor√°rio dispon√≠vel para esta data.</li>');
                    return;
                }
                
                timeSlots.forEach(function(slot) {
                    var li = $('<li>').addClass('checkbox-custom');
                    
                    if (slot.available) {
                        // Hor√°rio dispon√≠vel
                        var input = $('<input>').attr({
                            type: 'radio',
                            name: 'appointment_time',
                            id: 'time_' + slot.time.replace(':', '_'),
                            value: slot.time
                        });
                        var label = $('<label>').attr('for', 'time_' + slot.time.replace(':', '_'))
                            .html('<svg>...</svg><span>' + slot.time + '</span>');
                        
                        li.append(input).append(label);
                    } else {
                        // Hor√°rio indispon√≠vel (j√° agendado)
                        li.addClass('unavailable-slot');
                        var label = $('<label>').css({
                            'opacity': '0.6',
                            'cursor': 'not-allowed',
                            'background-color': '#ffebee',
                            'border-color': '#f44336',
                            'color': '#c62828',
                            'pointer-events': 'none'
                        }).html('<svg>...</svg><span>' + slot.time + ' (Indispon√≠vel)</span>');
                        
                        li.append(label);
                    }
                    
                    container.append(li);
                });
            }

            // Service selection
            var services = <%- JSON.stringify(services || []) %>;
            
            $('#serviceSelect').on('change', function() {
                var selectedId = $(this).val();
                var selectedService = services.find(service => service.id == selectedId);
                var freeService = selectedService ? selectedService.is_free : false;
                
                if (freeService == '1') {
                    $('.payment-method-form').addClass('d-none');
                    $('.free-appointment').removeClass('d-none');
                    var text = '<%= __('This service is completely free of charge! Simply click the Finish button to complete the process and book your service.') %>';
                    $('.free-appointment').html(text);
                } else {
                    $('.free-appointment').addClass('d-none');
                    $('.payment-method-form').removeClass('d-none');
                    if (selectedService) {
                        // currencySetting j√° vem como string JSON do servidor (JSON.stringify no controller)
                        // O EJS vai inserir a string JSON diretamente no c√≥digo JavaScript como string literal
                        // Precisamos garantir que seja tratado como string, n√£o como objeto
                        var currencySettingStr = <%- JSON.stringify(currencySetting) %>;
                        // formatCurrency espera uma string JSON que ser√° parseada internamente
                        try {
                            $('#serviceAmount').html('<%= __('Total Amount: ') %>' + formatCurrency(selectedService.price, currencySettingStr));
                        } catch(e) {
                            console.error('Erro ao formatar moeda:', e, 'currencySetting type:', typeof currencySettingStr, 'value:', currencySettingStr);
                            // Fallback simples
                            var price = parseFloat(selectedService.price || 0);
                            $('#serviceAmount').html('<%= __('Total Amount: ') %>R$ ' + price.toFixed(2).replace('.', ','));
                        }
                    }
                }
            });

            $('.payment_method').change(function() {
                var paymentMethod = $('input[name="payment_method"]:checked').data('payment');
                $('input[name="payment"]').val(paymentMethod);
            });

            $('#appointment-form').on('change', function(e) {
                var paymentAction = $('[data-payment-action]:checked').data("payment-action");
                var action = '/appointments/book';
                if (paymentAction) {
                    action = paymentAction;
                    $("#appointment-form").attr("action", paymentAction);
                }
            });

            // Form submission
            $(document).on('submit', '#appointment-form', function(e) {
                e.preventDefault();
                
                var $form = $(this);
                
                // CR√çTICO: Remover required de TODOS os campos escondidos ANTES de qualquer valida√ß√£o
                // Isso deve ser feito ANTES de qualquer outra valida√ß√£o para evitar erro do HTML5
                // Isso evita o erro "invalid form control is not focusable"
                // Primeiro, encontrar qual tab est√° ativo
                var activeTabId = $('#selected_tab').val() || 'new-user';
                var $activeTab = $form.find('.tab-content.active, .tab-content[id="' + activeTabId + '"]').first();
                
                console.log('üîç Tab ativo identificado:', activeTabId);
                console.log('   Tab element encontrado:', $activeTab.length > 0);
                
                // Remover required de TODOS os campos de TODOS os tabs primeiro
                $form.find('.tab-content').each(function() {
                    var $tab = $(this);
                    var isActiveTab = $tab.hasClass('active') || $tab.attr('id') === activeTabId;
                    
                    // Se N√ÉO √© o tab ativo, remover required de todos os campos
                    if (!isActiveTab) {
                        $tab.find('input[required], select[required], textarea[required]').each(function() {
                            var $field = $(this);
                            $field.prop('required', false);
                            $field.attr('data-was-required', 'true');
                            console.log('   ‚ùå Removido required de campo escondido:', $field.attr('name') || $field.attr('id'));
                        });
                    } else {
                        // Se √© o tab ativo, garantir que os campos t√™m required se necess√°rio
                        console.log('   ‚úÖ Mantendo required nos campos do tab ativo:', $tab.attr('id'));
                    }
                });
                
                // Tamb√©m remover required de campos fora de tabs que est√£o escondidos
                $form.find('input[required], select[required], textarea[required]').not('.tab-content input, .tab-content select, .tab-content textarea').each(function() {
                    var $field = $(this);
                    if ($field.css('display') === 'none' || $field.css('visibility') === 'hidden' || !$field.is(':visible')) {
                        $field.prop('required', false);
                        $field.attr('data-was-required', 'true');
                    }
                });
                
                // IMPORTANTE: Desabilitar TODOS os campos de tabs n√£o ativos para que n√£o sejam enviados
                $form.find('.tab-content').each(function() {
                    var $tab = $(this);
                    var isActiveTab = $tab.hasClass('active');
                    
                    if (!isActiveTab) {
                        // Desabilitar todos os campos deste tab n√£o ativo
                        $tab.find('input, select, textarea').each(function() {
                            var $field = $(this);
                            if (!$field.prop('disabled')) {
                                $field.prop('disabled', true);
                                $field.attr('data-was-disabled', 'false'); // Marcar que foi desabilitado por n√≥s
                            }
                        });
                    }
                });
                
                console.log('‚úÖ Campos de tabs n√£o ativos desabilitados');
                
                // Validar apenas campos vis√≠veis e com required
                var isValid = true;
                var firstInvalid = null;
                
                $form.find('input[required]:visible, select[required]:visible, textarea[required]:visible').each(function() {
                    var $field = $(this);
                    // Verificar se realmente est√° vis√≠vel
                    if ($field.css('display') !== 'none' && $field.is(':visible')) {
                        var value = $field.val();
                        if (!value || (typeof value === 'string' && value.trim() === '')) {
                            isValid = false;
                            $field.addClass('error');
                            if (!firstInvalid) {
                                firstInvalid = $field;
                            }
                        }
                    }
                });
                
                if (!isValid) {
                    alert('Por favor, preencha todos os campos obrigat√≥rios');
                    if (firstInvalid) {
                        firstInvalid.focus();
                    }
                    // Restaurar required nos campos
                    $form.find('[data-was-required="true"]').prop('required', true).removeAttr('data-was-required');
                    return false;
                }
                
                // Prevenir m√∫ltiplos envios
                if ($form.data('submitting')) {
                    console.log('‚ö†Ô∏è Formul√°rio j√° est√° sendo enviado. Ignorando...');
                    return false;
                }
                
                // √öLTIMA VERIFICA√á√ÉO: Remover required de TODOS os campos escondidos
                var selectedTabId = $('#selected_tab').val() || 'new-user';
                console.log('üîç √öltima verifica√ß√£o - Tab ativo:', selectedTabId);
                
                // Remover required de TODOS os campos que n√£o est√£o vis√≠veis
                $form.find('input[required], select[required], textarea[required]').each(function() {
                    var $field = $(this);
                    var isVisible = $field.is(':visible') && 
                                   $field.css('display') !== 'none' && 
                                   $field.css('visibility') !== 'hidden' &&
                                   !$field.prop('disabled');
                    
                    // Verificar se est√° dentro de um tab n√£o ativo
                    var $parentTab = $field.closest('.tab-content');
                    var isInActiveTab = false;
                    
                    if ($parentTab.length > 0) {
                        var tabId = $parentTab.attr('id');
                        isInActiveTab = $parentTab.hasClass('active') || tabId === selectedTabId;
                    } else {
                        // Campo n√£o est√° em tab, considerar vis√≠vel se estiver vis√≠vel
                        isInActiveTab = isVisible;
                    }
                    
                    if (!isInActiveTab || !isVisible) {
                        // Campo escondido - apenas remover required (n√£o desabilitar para n√£o bloquear intera√ß√£o)
                        console.log('   ‚ùå Removendo required de campo escondido:', $field.attr('name') || $field.attr('id'));
                        $field.prop('required', false);
                        // N√ÉO desabilitar - apenas remover required para evitar valida√ß√£o HTML5
                        $field.attr('data-was-required-removed', 'true');
                    } else {
                        // Campo vis√≠vel e ativo - garantir que est√° habilitado
                        $field.prop('disabled', false);
                    }
                });
                
                console.log('‚úÖ Verifica√ß√£o completa - todos os campos escondidos tiveram required removido');
                
                // Marcar formul√°rio como sendo enviado
                $form.data('submitting', true);
                
                // Desabilitar bot√£o de submit para evitar m√∫ltiplos cliques
                var $submitBtn = $form.find('button[type="submit"], button.appointment_payment, #generate-payment-btn');
                $submitBtn.prop('disabled', true);
                
                // IMPORTANTE: Buscar qual tab est√° realmente ativo no step de detalhes
                var $detailsStep = $form.find('.step-container').has('.tabs-container');
                var $activeTabContent = $detailsStep.find('.tab-content.active');
                var actualActiveTabId = $activeTabContent.attr('id') || selectedTabId;
                
                console.log('üîç Verificando tab ativo antes de enviar:');
                console.log('   selectedTabId (do hidden):', selectedTabId);
                console.log('   actualActiveTabId (do DOM):', actualActiveTabId);
                
                // Usar o tab que est√° realmente vis√≠vel no DOM
                var finalTabType = actualActiveTabId || selectedTabId || 'new-user';
                
                // Se n√£o encontrou pelo DOM, tentar buscar pelo elemento ativo
                if (!actualActiveTabId) {
                    var $activeTabInStep = $form.find('.step-container .tab-content.active').first();
                    if ($activeTabInStep.length > 0) {
                        finalTabType = $activeTabInStep.attr('id') || finalTabType;
                        console.log('   Tab ativo encontrado pelo step:', finalTabType);
                    }
                }
                
                // Garantir que o campo hidden type est√° atualizado
                $form.find('input[type="hidden"][name="type"]').val(finalTabType);
                $('#selected_tab').val(finalTabType); // Atualizar tamb√©m o ID do campo
                console.log('üìù Tipo final que ser√° enviado:', finalTabType);
                
                // Verificar se o tipo est√° correto antes de enviar
                if (finalTabType === 'existing-user' && (!$form.find('#email_existing').val() || !$form.find('#password_existing').val())) {
                    alert('Por favor, preencha o e-mail e a senha para continuar.');
                    $form.data('submitting', false);
                    $submitBtn.prop('disabled', false);
                    return false;
                }
                
                var formData = $form.serialize();
                
                console.log('üì§ Enviando formul√°rio...');
                console.log('   URL:', $form.attr('action') || '/appointments/book');
                console.log('   Dados:', formData.substring(0, 200) + '...');
                
                $('#loader').fadeIn();
                
                $.ajax({
                    url: $form.attr('action') || '/appointments/book',
                    method: 'POST',
                    data: formData,
                    timeout: 30000, // 30 segundos de timeout
                    success: function(response) {
                        console.log('‚úÖ Resposta recebida:', response);
                        $('#loader').fadeOut();
                        $form.data('submitting', false);
                        $submitBtn.prop('disabled', false);
                        
                        if (response.success) {
                            console.log('‚úÖ Agendamento criado com sucesso!');
                            console.log('   Appointment ID:', response.appointmentId);
                            console.log('   Tem PIX QR Code:', !!response.pixQrCode);
                            console.log('   Tem PIX C√≥digo:', !!response.pixCopiaECola);
                            console.log('   Tem Asaas Payment ID:', !!response.asaasPaymentId);
                            
                            // Sempre redirecionar para p√°gina de pagamento PIX quando houver pagamento
                            if (response.pixQrCode || response.pixCopiaECola || response.asaasPaymentId) {
                                // Salvar dados do pagamento no sessionStorage para exibir na p√°gina
                                sessionStorage.setItem('pixPayment', JSON.stringify({
                                    qrCode: response.pixQrCode,
                                    copiaECola: response.pixCopiaECola,
                                    appointmentId: response.appointmentId,
                                    value: response.value || null,
                                    asaasPaymentId: response.asaasPaymentId
                                }));
                                
                                // Redirecionar para p√°gina de pagamento PIX imediatamente
                                var paymentUrl = '/appointments/<%= slug %>/payment/' + response.appointmentId;
                                console.log('‚úÖ Redirecionando para:', paymentUrl);
                                
                                // Usar window.location.replace para garantir redirecionamento
                                window.location.replace(paymentUrl);
                            } else if (response.paymentUrl) {
                                // Redirecionar para URL de pagamento externa
                                console.log('‚úÖ Redirecionando para URL externa:', response.paymentUrl);
                                window.location.replace(response.paymentUrl);
                            } else {
                                // Se n√£o h√° pagamento (servi√ßo gratuito), ir direto para p√°gina de conclus√£o
                                var doneUrl = '/appointments/<%= slug %>/done/' + response.appointmentId;
                                console.log('‚úÖ Redirecionando para p√°gina de conclus√£o:', doneUrl);
                                window.location.replace(doneUrl);
                            }
                        } else {
                            console.error('‚ùå Erro na resposta:', response.message);
                            alert(response.message || 'Erro ao processar agendamento');
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loader').fadeOut();
                        $form.data('submitting', false);
                        $submitBtn.prop('disabled', false);
                        
                        var errorMsg = 'Erro ao processar agendamento';
                        var errorDetails = '';
                        
                        // Tentar extrair mensagem de erro detalhada
                        if (xhr.responseJSON) {
                            errorMsg = xhr.responseJSON.message || errorMsg;
                            if (xhr.responseJSON.error) {
                                errorDetails = '\n\nDetalhes: ' + (typeof xhr.responseJSON.error === 'string' ? xhr.responseJSON.error : JSON.stringify(xhr.responseJSON.error));
                            }
                        } else if (xhr.responseText) {
                            try {
                                var errorData = JSON.parse(xhr.responseText);
                                errorMsg = errorData.message || errorMsg;
                                if (errorData.error) {
                                    errorDetails = '\n\nDetalhes: ' + (typeof errorData.error === 'string' ? errorData.error : JSON.stringify(errorData.error));
                                }
                            } catch(e) {
                                errorMsg = xhr.responseText.substring(0, 200);
                            }
                        }
                        
                        // Verificar se foi timeout
                        if (status === 'timeout') {
                            errorMsg = 'Tempo de espera esgotado. Por favor, tente novamente.';
                        }
                        
                        // Mostrar erro completo
                        console.error('Erro completo:', xhr);
                        console.error('Status:', status);
                        console.error('Error:', error);
                        alert(errorMsg + errorDetails + '\n\nVerifique o console do servidor para mais detalhes.');
                    }
                });
                
                // Retornar false para prevenir submit padr√£o
                return false;
            });
            
            // Navega√ß√£o entre steps
            var totalSteps = $(".steps li").length;
            $(".steps li:nth-of-type(1)").addClass("active");
            $(".myContainer .step-container:nth-of-type(1)").addClass("active");
            
            // Bot√£o Next
            $(".step-container").on("click", ".next", function() {
                var currentStep = $(this).closest(".step-container");
                var currentIndex = currentStep.index();
                
                // Validar campos obrigat√≥rios antes de avan√ßar
                // IMPORTANTE: Validar apenas campos VIS√çVEIS (do tab ativo ou campos sem tab)
                var isValid = true;
                var firstInvalidField = null;
                
                // Remover classes de erro anteriores
                currentStep.find('input, select').removeClass('error');
                
                // Verificar se h√° tabs no step atual
                var hasTabs = currentStep.find('.tab-content').length > 0;
                
                if (hasTabs) {
                    // Se h√° tabs, validar apenas campos do tab ATIVO e VIS√çVEL
                    var activeTab = currentStep.find('.tab-content.active');
                    
                    if (activeTab.length === 0) {
                        // Se n√£o h√° tab ativo, tentar encontrar o primeiro vis√≠vel
                        activeTab = currentStep.find('.tab-content').filter(function() {
                            return $(this).css('display') !== 'none';
                        }).first();
                    }
                    
                    if (activeTab.length > 0) {
                        // Verificar se o tab est√° vis√≠vel
                        var tabDisplay = activeTab.css('display');
                        var tabVisibility = activeTab.css('visibility');
                        var tabOpacity = activeTab.css('opacity');
                        
                        // Validar apenas se o tab estiver realmente vis√≠vel
                        if (tabDisplay !== 'none' && tabVisibility !== 'hidden' && parseFloat(tabOpacity) > 0) {
                            // Buscar apenas campos dentro do tab ativo
                            activeTab.find('input[required], select[required]').each(function() {
                                var $field = $(this);
                                
                                // Verificar se o campo est√° dentro de um tab vis√≠vel
                                var $parentTab = $field.closest('.tab-content');
                                var parentDisplay = $parentTab.css('display');
                                var parentVisibility = $parentTab.css('visibility');
                                
                                // S√≥ validar se o campo est√° dentro do tab ativo e vis√≠vel
                                if ($parentTab.hasClass('active') && 
                                    parentDisplay !== 'none' && 
                                    parentVisibility !== 'hidden') {
                                    var value = $field.val();
                                    if (!value || (typeof value === 'string' && value.trim() === '')) {
                                        isValid = false;
                                        $field.addClass('error');
                                        if (!firstInvalidField) {
                                            firstInvalidField = $field;
                                        }
                                    }
                                }
                            });
                        }
                    }
                } else {
                    // Se n√£o h√° tabs, validar todos os campos obrigat√≥rios vis√≠veis
                    currentStep.find('input[required]:visible, select[required]:visible').each(function() {
                        var $field = $(this);
                        // Verificar se realmente est√° vis√≠vel
                        if ($field.css('display') !== 'none') {
                            var value = $field.val();
                            if (!value || value.trim() === '') {
                                isValid = false;
                                $field.addClass('error');
                                if (!firstInvalidField) {
                                    firstInvalidField = $field;
                                }
                            }
                        }
                    });
                }
                
                // Validar hor√°rio selecionado se estivermos no step de agendamento
                if (currentStep.find('#timeSlotsContainer').length > 0) {
                    var selectedTime = currentStep.find('input[name="appointment_time"]:checked').val();
                    if (!selectedTime) {
                        alert('Por favor, selecione um hor√°rio para o agendamento');
                        return false;
                    }
                    
                    // Verificar se o hor√°rio selecionado est√° dispon√≠vel
                    var timeSlotLi = currentStep.find('input[name="appointment_time"]:checked').closest('li');
                    if (timeSlotLi.hasClass('unavailable-slot')) {
                        alert('Este hor√°rio n√£o est√° mais dispon√≠vel. Por favor, selecione outro hor√°rio.');
                        return false;
                    }
                }
                
                // NOTA: A valida√ß√£o de credenciais de usu√°rio existente ser√° feita no backend
                // N√£o precisamos validar aqui para n√£o bloquear o submit
                
                if (!isValid) {
                    alert('Por favor, preencha todos os campos obrigat√≥rios');
                    if (firstInvalidField) {
                        firstInvalidField.focus();
                    }
                    return;
                }
                
                // Avan√ßar step
                if (currentIndex < $(".step-container").length - 1) {
                    currentStep.removeClass("active").next().addClass("active");
                    $(".steps li").eq(currentIndex).removeClass("active");
                    $(".steps li").eq(currentIndex + 1).addClass("active");
                }
            });
            
            // Bot√£o Back
            $(".step-container").on("click", ".back", function() {
                var currentStep = $(this).closest(".step-container");
                var currentIndex = currentStep.index();
                
                if (currentIndex > 0) {
                    currentStep.removeClass("active").prev().addClass("active");
                    $(".steps li").eq(currentIndex).removeClass("active");
                    $(".steps li").eq(currentIndex - 1).addClass("active");
                }
            });
            
            // Sistema de Tabs - Garantir que apenas um tab seja exibido
            function initTabs() {
                // Esconder todos os tabs que n√£o est√£o ativos
                $('.tab-content').each(function() {
                    var $tab = $(this);
                    if (!$tab.hasClass('active')) {
                        $tab.css({
                            'display': 'none',
                            'visibility': 'hidden',
                            'opacity': '0'
                        });
                        // IMPORTANTE: Remover required de campos em tabs inativos
                        $tab.find('input[required], select[required], textarea[required]').each(function() {
                            $(this).prop('required', false).attr('data-was-required', 'true');
                        });
                    } else {
                        // Garantir que o tab ativo est√° vis√≠vel
                        $tab.css({
                            'display': 'block',
                            'visibility': 'visible',
                            'opacity': '1'
                        });
                        // Restaurar required nos campos do tab ativo
                        $tab.find('[data-was-required="true"]').prop('required', true).removeAttr('data-was-required');
                    }
                });
            }
            
            // Inicializar tabs ao carregar (com delay para garantir que o DOM est√° pronto)
            setTimeout(function() {
                initTabs();
            }, 200);
            
            // Controlar clique nos tabs
            $(document).on("click", "ul.tabs li.tab-link", function(e) {
                e.preventDefault();
                var $this = $(this);
                var $theTab = $this.attr("data-tab");
                
                if ($this.hasClass("active")) {
                    return; // J√° est√° ativo
                }
                
                // Remover active de todos os tabs e conte√∫dos
                $this.closest(".tabs-wrapper")
                    .find("ul.tabs li.tab-link")
                    .removeClass("active");
                
                // Esconder todos os tabs e remover required de seus campos
                $this.closest(".tabs-wrapper")
                    .find('.tabs-container .tab-content')
                    .each(function() {
                        var $tab = $(this);
                        $tab.removeClass("active").css({
                            'display': 'none',
                            'visibility': 'hidden',
                            'opacity': '0'
                        });
                        // Remover required de campos escondidos (mas N√ÉO desabilitar)
                        $tab.find('input[required], select[required], textarea[required]').each(function() {
                            $(this).prop('required', false).attr('data-was-required', 'true');
                            // N√ÉO desabilitar - apenas remover required
                        });
                    });
                
                // Adicionar active no tab clicado e seu conte√∫do
                $this.addClass("active");
                var $targetContent = $this.closest(".tabs-wrapper")
                    .find('.tabs-container .tab-content[id="' + $theTab + '"]');
                
                $targetContent.addClass("active").css({
                    'display': 'block',
                    'visibility': 'visible',
                    'opacity': '1'
                });
                
                // Restaurar required nos campos do tab ativo
                // Remover required de TODOS os campos de TODOS os tabs primeiro
                $('#appointment-form .tab-content').each(function() {
                    var $tab = $(this);
                    if ($tab.attr('id') !== $theTab) {
                        // Tab n√£o ativo - remover required (mas N√ÉO desabilitar ainda)
                        $tab.find('input[required], select[required], textarea[required]').each(function() {
                            var $field = $(this);
                            if (!$field.attr('data-was-required')) {
                                $field.attr('data-was-required', 'true');
                            }
                            $field.prop('required', false);
                            // N√ÉO desabilitar aqui - apenas remover required
                        });
                    }
                });
                
                // Restaurar required e garantir que est√° habilitado no tab ativo
                $targetContent.find('[data-was-required="true"]').each(function() {
                    var $field = $(this);
                    $field.prop('required', true);
                    $field.removeAttr('data-was-required');
                });
                // CR√çTICO: Garantir que TODOS os campos do tab ativo est√£o habilitados e edit√°veis
                $targetContent.find('input, select, textarea').prop('disabled', false).prop('readonly', false);
                
                // Atualizar campo hidden
                $('#selected_tab').val($theTab);
                
                console.log('‚úÖ Tab ativado:', $theTab, '- Campos habilitados');
                
                // Chamar fun√ß√£o de limpeza para garantir
                removeRequiredFromHiddenFields();
                
                // Limpar valida√ß√µes anteriores
                $this.closest(".step-container").find('input, select').removeClass('error');
            });
            
            // Valida√ß√£o de email - Verificar se j√° existe quando usu√°rio digita no "Novo Cadastro"
            var emailCheckTimeout;
            $('#email_new').on('blur', function() {
                var email = $(this).val().trim();
                
                if (!email || !email.includes('@')) {
                    return; // Email inv√°lido, n√£o verificar
                }
                
                // Limpar timeout anterior
                clearTimeout(emailCheckTimeout);
                
                // Aguardar 500ms ap√≥s parar de digitar
                emailCheckTimeout = setTimeout(function() {
                    $.ajax({
                        url: '/api/appointments/check-user',
                        method: 'POST',
                        data: {
                            email: email,
                            password: '' // N√£o precisamos da senha para verificar se existe
                        },
                        success: function(response) {
                            if (response.success && response.exists) {
                                // Email j√° existe - mudar para tab "J√° Tenho Conta"
                                alert('Este e-mail j√° est√° cadastrado. Por favor, use a op√ß√£o "J√° Tenho Conta" para fazer login.');
                                
                                // Mudar para tab "J√° Tenho Conta"
                                $('ul.tabs li.tab-link[data-tab="existing-user"]').click();
                                
                                // Preencher o email no tab "J√° Tenho Conta"
                                $('#email_existing').val(email);
                                
                                // Limpar campos do "Novo Cadastro"
                                $('#name_new').val('');
                                $('#email_new').val('');
                                $('#password').val('');
                                $('#contact').val('');
                            }
                        },
                        error: function() {
                            // Erro na verifica√ß√£o, mas n√£o bloquear
                            console.log('Erro ao verificar email');
                        }
                    });
                }, 500);
            });
        });
    </script>
</body>
</html>

